<!-- Vectors Enhanced - Modular Settings Template -->
<div id="vectors_enhanced_container" class="inline-drawer">
  <div class="inline-drawer-toggle inline-drawer-header">
    <b>聊天记录超级管理器</b>
    <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
  </div>
  <div class="inline-drawer-content">
    <!-- Custom Styles -->
    <link rel="stylesheet" href="src/ui/styles/components.css">

    <!-- Master Switch -->
    <div class="vectors-enhanced-section" style="padding-bottom: 0.5rem; border-bottom: 2px solid var(--SmartThemeQuoteColor)">
      <label class="checkbox_label" for="vectors_enhanced_master_enabled" title="启用/禁用整个插件的所有功能。禁用时，所有向量化和查询功能都将停止工作。">
        <input id="vectors_enhanced_master_enabled" type="checkbox" />
        <span style="font-weight: bold; color: var(--SmartThemeQuoteColor)">启用聊天记录超级管理器</span>
      </label>
      <small style="display: block; margin-top: 0.25rem; color: var(--SmartThemeEmColor)">
        关闭此开关将禁用插件的所有功能，包括向量化、查询和任务管理
      </small>
    </div>

    <!-- Content Selection -->
    <div id="vectors_enhanced_content_settings" class="vectors-enhanced-section">
      <details>
        <summary><strong>内容选择</strong></summary>

      <!-- Chat Messages -->
      <div class="content-type-section">
        <label class="checkbox_label" for="vectors_enhanced_chat_enabled">
          <input id="vectors_enhanced_chat_enabled" type="checkbox" />
          <span>聊天消息</span>
        </label>

        <div id="vectors_enhanced_chat_settings" class="content-settings">
          <div class="flex-container">
            <div class="flex1">
              <label for="vectors_enhanced_chat_start">
                <small>从消息 #</small>
              </label>
              <input id="vectors_enhanced_chat_start" type="number" class="text_pole vectors-range-input" min="0" value="0" />
            </div>
            <div class="flex1">
              <label for="vectors_enhanced_chat_end">
                <small>到消息 # (-1 表示最后)</small>
              </label>
              <input id="vectors_enhanced_chat_end" type="number" class="text_pole vectors-range-input" value="-1" />
            </div>
          </div>

          <div class="flex-container flexFlowColumn m-t-0-5">
            <label>
              <small>消息类型</small>
            </label>
            <label class="checkbox_label">
              <input id="vectors_enhanced_chat_user" type="checkbox" checked />
              <span>用户消息</span>
            </label>
            <label class="checkbox_label">
              <input id="vectors_enhanced_chat_assistant" type="checkbox" checked />
              <span>AI消息</span>
            </label>
            <label class="checkbox_label">
              <input id="vectors_enhanced_chat_include_hidden" type="checkbox" />
              <span>包含隐藏消息</span>
            </label>
          </div>

          <!-- Hidden Message Management -->
          <div class="flex-container flexFlowColumn m-t-1 vectors-hidden-message-section">
            <label class="vectors-enhanced-subsection-title">
              <small>隐藏消息管理</small>
            </label>

            <small class="text-muted margin-bottom-10px">勾选"包含隐藏消息"后，隐藏的消息也会被包含在向量化中</small>

            <div class="flex-container m-t-0-5">
              <button id="vectors_enhanced_hide_range" class="menu_button menu_button_icon" title="隐藏选定范围的消息">
                <i class="fa-solid fa-eye-slash"></i>
                <span>隐藏消息</span>
              </button>
              <button id="vectors_enhanced_unhide_range" class="menu_button menu_button_icon" title="显示选定范围的消息">
                <i class="fa-solid fa-eye"></i>
                <span>显示消息</span>
              </button>
              <button id="vectors_enhanced_show_hidden" class="menu_button menu_button_icon" title="查看当前隐藏的消息">
                <i class="fa-solid fa-list"></i>
                <span>查看隐藏</span>
              </button>
            </div>

            <div id="vectors_enhanced_hidden_info" class="vectors-hidden-info">
              <div class="text-muted">
                <strong>当前隐藏消息: <span id="vectors_enhanced_hidden_count">0</span></strong>
              </div>
            </div>
          </div>

          <!-- Tag Extraction Rules -->
          <div class="flex-container flexFlowColumn m-t-0-5">
            <div class="flex-container alignItemsCenter">
              <label class="flex1 vectors-enhanced-subsection-title">
                <small>标签提取规则</small>
              </label>
              <button id="vectors_enhanced_tag_examples" class="menu_button menu_button_icon vectors-tag-examples-btn" title="查看标签提取功能的使用方法和示例">
                <i class="fa-solid fa-lightbulb"></i>
                <span>查看示例</span>
              </button>
            </div>
            <div id="vectors_enhanced_rules_editor">
              <!-- Rules editor will be dynamically generated -->
            </div>
            <div class="flex-container vectors-tag-actions">
              <button id="vectors_enhanced_add_rule" class="menu_button menu_button_icon">
                <i class="fa-solid fa-plus"></i>
                <span>添加新规则</span>
              </button>
              <button id="vectors_enhanced_tag_scanner" class="menu_button menu_button_icon" title="扫描当前选择的内容中存在的标签以作为规则建议">
                <i class="fa-solid fa-search"></i>
                <span>扫描标签</span>
              </button>
              <button id="vectors_enhanced_exclude_cot" class="menu_button menu_button_icon" title="快速添加一条正则规则，用于排除HTML注释格式的思维链（CoT）">
                <i class="fa-solid fa-comment-slash"></i>
                <span>排除小CoT</span>
              </button>
            </div>

            <!-- Tag Suggestions -->
            <div id="vectors_enhanced_tag_suggestions" class="vectors-tag-suggestions">
              <div class="flex-container alignItemsCenter m-b-0-5">
                <small class="text-muted flex1">
                  <strong>发现的标签 (<span id="vectors_tag_scan_stats"></span>):</strong>
                </small>
                <button id="vectors_enhanced_clear_suggestions" class="menu_button menu_button_icon fa-solid fa-times" title="清除建议"></button>
              </div>
              <div id="vectors_enhanced_tag_list">
                <!-- Tag suggestions will be dynamically generated -->
              </div>
            </div>
          </div>

          <!-- Content Blacklist -->
          <div class="flex-container flexFlowColumn m-t-0-5">
            <label for="vectors_enhanced_content_blacklist" class="vectors-enhanced-subsection-title">
              <small>内容过滤黑名单（一行一个关键词或短语）</small>
            </label>
            <textarea id="vectors_enhanced_content_blacklist" class="text_pole textarea_compact" rows="3" placeholder="Step&#10;思考过程&#10;推理步骤&#10;让我想想"></textarea>
            <details class="text-muted margin-bottom-10px">
              <summary><small><strong>黑名单功能</strong></small></summary>
              <div><small>• 包含这些关键词的提取内容将被跳过</small></div>
              <div><small>• 支持中英文关键词</small></div>
              <div><small>• 与排除语法配合使用：先排除子标签，再进行黑名单过滤</small></div>
              <div><small>处理顺序：提取标签 → 排除子标签 → 黑名单过滤</small></div>
            </details>
          </div>
        </div>
      </div>

      <!-- Files -->
      <div class="content-type-section">
        <label class="checkbox_label" for="vectors_enhanced_files_enabled">
          <input id="vectors_enhanced_files_enabled" type="checkbox" />
          <span>文件</span>
        </label>

        <div id="vectors_enhanced_files_settings" class="content-settings">
          <div id="vectors_enhanced_files_list" class="file-list">
            <!-- File list will be dynamically populated -->
          </div>
          <button id="vectors_enhanced_files_refresh" class="menu_button">
            <i class="fa-solid fa-refresh"></i>
            <span>刷新文件列表</span>
          </button>
        </div>
      </div>

      <!-- World Info -->
      <div class="content-type-section">
        <label class="checkbox_label" for="vectors_enhanced_wi_enabled">
          <input id="vectors_enhanced_wi_enabled" type="checkbox" />
          <span>世界信息</span>
        </label>

        <div id="vectors_enhanced_wi_settings" class="content-settings">
          <div id="vectors_enhanced_wi_list" class="wi-list">
            <!-- World info entries will be dynamically populated -->
          </div>
          <button id="vectors_enhanced_wi_refresh" class="menu_button">
            <i class="fa-solid fa-refresh"></i>
            <span>刷新世界信息</span>
          </button>
        </div>
      </div>
      </details>
    </div>

    <!-- Vectorization & Injection Settings -->
    <div id="vectors_enhanced_vectorization_settings" class="vectors-enhanced-section">
      <details>
        <summary><strong>向量化设置</strong></summary>

        <!-- Source Selection -->
        <div class="flex-container flexFlowColumn">
          <label for="vectors_enhanced_source">向量化源</label>
          <select id="vectors_enhanced_source" class="text_pole">
            <option value="transformers">Transformers (本地)</option>
            <option value="vllm">vLLM</option>
            <option value="ollama">Ollama</option>
            <option value="webllm">WebLLM (本地)</option>
            <option value="openai">OpenAI API</option>
            <option value="cohere">Cohere API</option>
          </select>
        </div>

        <!-- Transformers Settings -->
        <div id="vectors_enhanced_transformers_settings" class="vectors-source-settings">
          <div class="flex-container flexFlowColumn">
            <label for="vectors_enhanced_local_model">本地模型</label>
            <input id="vectors_enhanced_local_model" class="text_pole" type="text" placeholder="Xenova/all-MiniLM-L6-v2" />
          </div>
        </div>

        <!-- vLLM Settings -->
        <div id="vectors_enhanced_vllm_settings" class="vectors-source-settings vectors-vllm-settings">
          <div class="flex-container flexFlowColumn">
            <label for="vectors_enhanced_vllm_url">vLLM API 地址</label>
            <input id="vectors_enhanced_vllm_url" class="text_pole" type="text" placeholder="http://127.0.0.1:8000" />
          </div>
          <div class="flex-container flexFlowColumn">
            <label for="vectors_enhanced_vllm_model">vLLM 模型名称</label>
            <input id="vectors_enhanced_vllm_model" class="text_pole" type="text" placeholder="BAAI/bge-large-zh-v1.5" />
          </div>
        </div>

        <!-- Ollama Settings -->
        <div id="vectors_enhanced_ollama_settings" class="vectors-source-settings vectors-ollama-settings">
          <div class="flex-container flexFlowColumn">
            <label for="vectors_enhanced_ollama_url">Ollama API 地址</label>
            <input id="vectors_enhanced_ollama_url" class="text_pole" type="text" placeholder="http://localhost:11434" />
          </div>
          <div class="flex-container flexFlowColumn">
            <label for="vectors_enhanced_ollama_model">Ollama 模型名称</label>
            <input id="vectors_enhanced_ollama_model" class="text_pole" type="text" placeholder="rjmalagon/gte-qwen2-1.5b-instruct-embed-f16" />
          </div>
          <label class="checkbox_label" for="vectors_enhanced_ollama_keep">
            <input id="vectors_enhanced_ollama_keep" type="checkbox" />
            <span>保持模型在内存中</span>
          </label>
        </div>

        <!-- General Parameters -->
        <div class="flex-container m-t-1">
          <div class="flex1" title="向量化的文本块大小">
            <label for="vectors_enhanced_chunk_size">
              <small>块大小</small>
            </label>
            <input id="vectors_enhanced_chunk_size" type="number" class="text_pole" min="100" max="10000" />
          </div>
          <div class="flex1" title="块之间的重叠百分比">
            <label for="vectors_enhanced_overlap_percent">
              <small>重叠 %</small>
            </label>
            <input id="vectors_enhanced_overlap_percent" type="number" class="text_pole" min="0" max="50" />
          </div>
          <div class="flex1" title="检索的最小相似度分数">
            <label for="vectors_enhanced_score_threshold">
              <small>分数阈值</small>
            </label>
            <input id="vectors_enhanced_score_threshold" type="number" class="text_pole" min="0" max="1" step="0.05" />
          </div>
        </div>

        <div class="flex-container flexFlowColumn m-t-0-5">
          <label for="vectors_enhanced_force_chunk_delimiter" title="块边界的自定义分隔符">
            <small>自定义块分隔符</small>
          </label>
          <input id="vectors_enhanced_force_chunk_delimiter" class="text_pole" type="text" placeholder="（可选）" />
        </div>

        <!-- Enable Vector Query -->
        <label class="checkbox_label" for="vectors_enhanced_enabled" title="启用/禁用向量查询功能（已向量化的内容不会受影响）">
          <input id="vectors_enhanced_enabled" type="checkbox" />
          <span>启用向量查询</span>
        </label>

        <!-- Show Query Notification -->
        <label class="checkbox_label" for="vectors_enhanced_show_query_notification" title="每次向量查询后显示结果统计">
          <input id="vectors_enhanced_show_query_notification" type="checkbox" />
          <span>显示查询结果通知</span>
        </label>

        <!-- Detailed Notification Details -->
        <div id="vectors_enhanced_notification_details" style="margin-left: 1.5rem; display: none;">
          <label class="checkbox_label" for="vectors_enhanced_detailed_notification" title="显示各来源的详细分布（聊天记录、文件、世界信息）">
            <input id="vectors_enhanced_detailed_notification" type="checkbox" />
            <span>详细模式（显示来源分布）</span>
          </label>
        </div>

        <hr class="m-t-1 m-b-1">
        <h4 class="m-t-1">注入设置</h4>

        <div class="flex-container flexFlowColumn">
          <label for="vectors_enhanced_template">注入模板</label>
          <textarea id="vectors_enhanced_template" class="text_pole textarea_compact" rows="3" placeholder="使用 {{text}} 指定检索内容的位置"></textarea>
        </div>

        <!-- Content Tags -->
        <div class="flex-container flexFlowColumn m-t-0-5">
          <label>
            <small>内容标签（用于区分不同来源的内容）</small>
          </label>
          <div class="flex-container">
            <div class="flex1">
              <label for="vectors_enhanced_tag_chat">
                <small>聊天记录</small>
              </label>
              <input id="vectors_enhanced_tag_chat" class="text_pole" type="text" placeholder="past_chat" />
            </div>
            <div class="flex1">
              <label for="vectors_enhanced_tag_wi">
                <small>世界信息</small>
              </label>
              <input id="vectors_enhanced_tag_wi" class="text_pole" type="text" placeholder="world_part" />
            </div>
            <div class="flex1">
              <label for="vectors_enhanced_tag_file">
                <small>文件</small>
              </label>
              <input id="vectors_enhanced_tag_file" class="text_pole" type="text" placeholder="databank" />
            </div>
          </div>
        </div>

        <!-- Injection Position -->
        <label>注入位置</label>
        <div class="radio_group">
          <label>
            <input type="radio" name="vectors_position" value="2" />
            <span>主提示前</span>
          </label>
          <label>
            <input type="radio" name="vectors_position" value="0" />
            <span>主提示后</span>
          </label>
          <label>
            <input type="radio" name="vectors_position" value="1" />
            <span>聊天内@深度</span>
            <input id="vectors_enhanced_depth" class="text_pole widthUnset vectors-depth-input" type="number" min="0" max="999" />
            <span>作为</span>
            <select id="vectors_enhanced_depth_role" class="text_pole widthNatural">
              <option value="0">系统</option>
              <option value="1">用户</option>
              <option value="2">助手</option>
            </select>
          </label>
        </div>

        <label class="checkbox_label" for="vectors_enhanced_include_wi">
          <input id="vectors_enhanced_include_wi" type="checkbox" />
          <span>包含在世界信息扫描中</span>
        </label>

        <label class="checkbox_label" for="vectors_enhanced_auto_vectorize" title="当聊天内容发生变化时（如发送/接收消息、编辑消息等），自动重新向量化选中的内容。关闭此选项需要手动点击'向量化'按钮。">
          <input id="vectors_enhanced_auto_vectorize" type="checkbox" />
          <span>更改时自动向量化</span>
        </label>
      </details>
    </div>

    <!-- Rerank Settings -->
    <div id="vectors_enhanced_rerank_settings" class="vectors-enhanced-section">
      <details>
        <summary><strong>Rerank 设置</strong></summary>

        <label class="checkbox_label" for="vectors_enhanced_rerank_enabled" title="启用/禁用Rerank模型对搜索结果进行重排序">
          <input id="vectors_enhanced_rerank_enabled" type="checkbox" />
          <span>启用 Rerank</span>
        </label>

        <label class="checkbox_label" for="vectors_enhanced_rerank_success_notify" title="在Rerank成功时显示通知">
          <input id="vectors_enhanced_rerank_success_notify" type="checkbox" />
          <span>显示 Rerank 成功通知</span>
        </label>

        <div class="flex-container flexFlowColumn m-t-0-5">
          <label for="vectors_enhanced_rerank_url">Rerank API URL</label>
          <input id="vectors_enhanced_rerank_url" class="text_pole" type="text" placeholder="例如：https://api.siliconflow.cn/v1/rerank">

          <label for="vectors_enhanced_rerank_apiKey">Rerank API Key</label>
          <input id="vectors_enhanced_rerank_apiKey" class="text_pole" type="password" placeholder="输入您的API Key">

          <label for="vectors_enhanced_rerank_model">Rerank 模型</label>
          <input id="vectors_enhanced_rerank_model" class="text_pole" type="text" placeholder="例如：Pro/BAAI/bge-reranker-v2-m3">

          <div class="flex-container">
            <div class="flex1" title="在Rerank前，从向量搜索中获取的候选项数量">
              <label for="vectors_enhanced_rerank_top_n"><small>Rerank Top N</small></label>
              <input id="vectors_enhanced_rerank_top_n" type="number" class="text_pole" min="1" max="100">
            </div>
            <div class="flex1" title="混合分数中Rerank分数的权重 (0-1)">
              <label for="vectors_enhanced_rerank_hybrid_alpha"><small>混合权重</small></label>
              <input id="vectors_enhanced_rerank_hybrid_alpha" type="number" class="text_pole" min="0" max="1" step="0.1">
            </div>
          </div>
        </div>
      </details>
    </div>

    <!-- Task List -->
    <div id="vectors_enhanced_tasks_settings" class="vectors-enhanced-section">
      <details>
        <summary><strong>向量化任务</strong></summary>
        <div id="vectors_enhanced_task_list" class="task-list">
          <!-- Task list will be dynamically populated -->
        </div>

        <!-- External Task Import Button -->
        <div class="flex-container alignItemsCenter" style="margin-top: 1rem; padding-top: 0.5rem; border-top: 1px solid var(--SmartThemeBorderColor);">
          <button id="vectors_enhanced_import_external_task" class="menu_button" style="width: auto; min-width: fit-content;">
            <i class="fa-solid fa-file-import"></i> 导入外挂任务
          </button>
        </div>
      </details>
    </div>

    <!-- Memory Management -->
    <div id="vectors_enhanced_memory" class="vectors-enhanced-section">
      <details>
        <summary><strong>记忆管理</strong></summary>
        <div style="padding: 10px;">
          <div class="memory-description">
            <small style="color: var(--SmartThemeEmColor)">
              与当前AI进行对话，测试记忆管理功能
            </small>
          </div>
          
          <!-- API Selection (moved to top) -->
          <div class="memory-api-section" style="margin-top: 10px;">
            <label for="memory_api_source">
              <small>API 选择:</small>
            </label>
            <select id="memory_api_source" class="text_pole" style="width: 100%;">
              <option value="google">Google AI Studio</option>
              <option value="openai_compatible">OpenAI兼容格式</option>
            </select>
            
            <!-- Google AI Studio Settings -->
            <div id="memory_google_settings" style="margin-top: 10px; display: none;">
              <label for="memory_google_api_key">
                <small>Google AI API Key:</small>
              </label>
              <input id="memory_google_api_key" 
                     type="password" 
                     class="text_pole" 
                     placeholder="AIza..." 
                     style="width: 100%;" />
              
              <label for="memory_google_model" style="margin-top: 5px;">
                <small>模型名称:</small>
              </label>
              <input id="memory_google_model" 
                     type="text" 
                     class="text_pole" 
                     placeholder="例如: gemini-pro, gemini-1.5-pro-latest" 
                     style="width: 100%;" />
            </div>
            
            <!-- OpenAI Compatible Settings -->
            <div id="memory_openai_settings" style="margin-top: 10px; display: none;">
              <label for="memory_openai_url">
                <small>API端点URL:</small>
              </label>
              <input id="memory_openai_url" 
                     type="text" 
                     class="text_pole" 
                     placeholder="https://api.openai.com/v1" 
                     style="width: 100%;" />
              
              <label for="memory_openai_api_key" style="margin-top: 5px;">
                <small>API Key:</small>
              </label>
              <input id="memory_openai_api_key" 
                     type="password" 
                     class="text_pole" 
                     placeholder="sk-..." 
                     style="width: 100%;" />
              
              <label for="memory_openai_model" style="margin-top: 5px;">
                <small>模型名称:</small>
              </label>
              <input id="memory_openai_model" 
                     type="text" 
                     class="text_pole" 
                     placeholder="例如: gpt-3.5-turbo, gpt-4, claude-3-sonnet, deepseek-chat" 
                     style="width: 100%;" />
            </div>
          </div>
          
          <!-- Input Area -->
          <div class="memory-input-section" style="margin-top: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
              <label for="memory_input">
                <small>输入消息:</small>
              </label>
              <button id="memory_inject_content" 
                      class="menu_button menu_button_icon" 
                      title="将提取的内容注入到输入框"
                      style="padding: 5px 10px; font-size: 0.9em;">
                <i class="fa-solid fa-syringe"></i>
                <span>注入提取内容</span>
              </button>
            </div>
            <textarea id="memory_input" 
                     class="text_pole" 
                     rows="4" 
                     placeholder="在这里输入你想发送给AI的消息..."
                     style="width: 100%; resize: vertical;"></textarea>
          </div>
          
          <!-- Prompts Section (collapsible) -->
          <details style="margin-top: 10px;">
            <summary style="cursor: pointer;">
              <small><strong>提示词设置</strong></small>
            </summary>
            <div style="padding: 10px 0;">
              <!-- System Prompt -->
              <div class="memory-prompt-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                  <label for="memory_system_prompt">
                    <small>系统提示词 (可选):</small>
                  </label>
                  <button id="memory_system_prompt_restore" 
                          class="menu_button menu_button_icon" 
                          title="恢复默认系统提示词"
                          style="padding: 3px 8px; font-size: 0.8em;">
                    <i class="fa-solid fa-undo"></i>
                    <span>恢复默认</span>
                  </button>
                </div>
                <textarea id="memory_system_prompt" 
                         class="text_pole" 
                         rows="3" 
                         placeholder="设置AI的角色和行为，例如：你是一个友好的助手..."
                         style="width: 100%; resize: vertical;"></textarea>
              </div>
              
              <!-- Suffix Prompt -->
              <div class="memory-suffix-section" style="margin-top: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                  <label for="memory_suffix_prompt">
                    <small>尾部提示词 (可选):</small>
                  </label>
                  <button id="memory_suffix_prompt_restore" 
                          class="menu_button menu_button_icon" 
                          title="恢复默认尾部提示词"
                          style="padding: 3px 8px; font-size: 0.8em;">
                    <i class="fa-solid fa-undo"></i>
                    <span>恢复默认</span>
                  </button>
                </div>
                <textarea id="memory_suffix_prompt" 
                         class="text_pole" 
                         rows="2" 
                         placeholder="会附加在用户输入后面，例如：请用中文回答..."
                         style="width: 100%; resize: vertical;"></textarea>
              </div>
            </div>
          </details>
          
          <!-- Send Button -->
          <div class="memory-actions" style="margin-top: 10px;">
            <button id="memory_send_btn" 
                    class="menu_button menu_button_icon" 
                    style="width: 100%;">
              <i class="fa-solid fa-paper-plane"></i>
              <span>发送</span>
            </button>
          </div>
          
          <!-- Output Area -->
          <div class="memory-output-section" style="margin-top: 15px;">
            <label for="memory_output">
              <small>AI回复:</small>
            </label>
            <textarea id="memory_output" 
                     class="text_pole" 
                     rows="6" 
                     readonly 
                     placeholder="AI的回复将显示在这里..."
                     style="width: 100%; resize: vertical; background-color: var(--black30a);"></textarea>
          </div>
          
          <!-- Loading Indicator -->
          <div id="memory_loading" 
               style="display: none; text-align: center; margin-top: 10px;">
            <i class="fa-solid fa-spinner fa-spin"></i>
            <span style="margin-left: 5px;">正在处理...</span>
          </div>

          <!-- Injection Settings -->
          <hr class="m-t-1 m-b-1">
          <h4 class="m-t-1">注入设置</h4>
          
          <!-- Enable Injection -->
          <div class="flex-container">
            <label class="checkbox_label" for="memory_injection_enabled">
              <input id="memory_injection_enabled" type="checkbox" />
              <span>启用记忆内容注入到聊天</span>
            </label>
          </div>

          <!-- Injection Template -->
          <div class="flex-container flexFlowColumn m-t-0-5">
            <label for="memory_injection_template">注入模板</label>
            <textarea id="memory_injection_template" 
                      class="text_pole textarea_compact" 
                      rows="3" 
                      placeholder="使用 {{text}} 指定记忆内容的位置"></textarea>
          </div>

          <!-- Injection Position -->
          <label class="m-t-0-5">注入位置</label>
          <div class="radio_group">
            <label>
              <input type="radio" name="memory_injection_position" value="2" />
              <span>主提示前</span>
            </label>
            <label>
              <input type="radio" name="memory_injection_position" value="0" />
              <span>主提示后</span>
            </label>
            <label>
              <input type="radio" name="memory_injection_position" value="1" />
              <span>聊天中</span>
            </label>
          </div>

          <!-- Depth Settings (shown when position is "In Chat") -->
          <div id="memory_injection_depth_settings" style="display: none;">
            <div class="flex-container m-t-0-5">
              <div class="flex1">
                <label for="memory_injection_depth">
                  <small>注入深度</small>
                </label>
                <input id="memory_injection_depth" 
                       type="number" 
                       min="0" 
                       max="99"
                       class="text_pole" />
              </div>
              <div class="flex1" style="margin-left: 10px;">
                <label for="memory_injection_depth_role">
                  <small>角色</small>
                </label>
                <select id="memory_injection_depth_role" class="text_pole">
                  <option value="0">System</option>
                  <option value="1">User</option>
                  <option value="2">Assistant</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Include in WI scan -->
          <label class="checkbox_label m-t-0-5" for="memory_injection_include_wi">
            <input id="memory_injection_include_wi" type="checkbox" />
            <span>包含在 WI 扫描中</span>
          </label>

          <!-- Test Injection Button -->
          <hr class="m-t-1 m-b-1">
          <h4 class="m-t-1">测试注入</h4>
          <button id="memory_test_injection" 
                  class="menu_button menu_button_icon" 
                  title="测试注入内容的效果"
                  style="width: 100%;">
            <i class="fa-solid fa-vial"></i>
            <span>测试注入效果</span>
          </button>
          <div id="memory_test_result" 
               class="memory-test-result" 
               style="display: none; margin-top: 10px;">
            <label for="memory_test_output">
              <small>测试结果：</small>
            </label>
            <textarea id="memory_test_output" 
                     class="text_pole" 
                     rows="6" 
                     readonly 
                     style="width: 100%; resize: vertical; background-color: var(--black30a);"></textarea>
          </div>
          
          <!-- World Book Creation Button -->
          <hr class="m-t-1 m-b-1">
          <h4 class="m-t-1">世界书创建</h4>
          <button id="memory_create_world_book" 
                  class="menu_button menu_button_icon" 
                  title="创建一本以当前角色名和聊天创建时间命名的世界书"
                  style="width: 100%;">
            <i class="fa-solid fa-book"></i>
            <span>创建世界书 (角色名 YY/MM/DD HH:MM)</span>
          </button>
        </div>
      </details>
    </div>

    <!-- Action Buttons -->
    <div id="vectors_enhanced_actions_settings" class="vectors-enhanced-section">
        <!-- Preview Options -->
        <div class="vectors-enhanced-preview-options" style="margin-bottom: 0.5rem;">
          <label class="checkbox_label" for="vectors_enhanced_preview_raw">
            <input id="vectors_enhanced_preview_raw" type="checkbox" />
            <span>预览时显示原始内容（标签筛选后）</span>
          </label>
        </div>
        <div class="vectors-enhanced-actions flex-container">
          <button id="vectors_enhanced_preview" class="menu_button menu_button_icon">
            <i class="fa-solid fa-eye"></i>
            <span>预览</span>
          </button>
          <button id="vectors_enhanced_export" class="menu_button menu_button_icon">
            <i class="fa-solid fa-download"></i>
            <span>导出</span>
          </button>
          <button id="vectors_enhanced_vectorize" class="menu_button menu_button_icon">
            <i class="fa-solid fa-vector-square"></i>
            <span>向量化</span>
          </button>
          <button id="vectors_enhanced_abort" class="menu_button menu_button_icon vectors-btn-hidden" title="中断向量化">
            <i class="fa-solid fa-stop"></i>
            <span>中断</span>
          </button>
        </div>

        <!-- Progress Bar -->
        <div id="vectors_enhanced_progress" class="vectors-enhanced-progress">
          <div class="progress-bar">
            <div class="progress-bar-inner"></div>
          </div>
          <div class="progress-text">准备中...</div>
        </div>

        <!-- Status Display -->
        <div id="vectors_enhanced_status" class="vectors-enhanced-status">
          <!-- Status messages will be displayed here -->
        </div>
      </div>
    </div>

  </div>
</div>
