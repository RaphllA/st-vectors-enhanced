# Vectors Enhanced 项目简介

## 项目概述
Vectors Enhanced 是 SillyTavern 的第三方扩展插件，提供了先进的向量化和语义搜索功能。该插件允许用户对聊天历史、文件和世界信息进行向量化处理，并在对话中动态注入相关内容。

## 当前状态
项目已经拥有完整的功能实现，但代码架构存在严重的耦合问题。主文件 `index.js` 超过5000行，集成了UI、业务逻辑、数据处理和API调用等多个职责。

## 核心功能
1. **内容向量化**
   - 支持聊天消息、文件、世界信息的向量化
   - 多种向量化引擎：Transformers.js（本地）、Ollama、vLLM、WebLLM
   - 支持批量处理和增量更新

2. **向量管理**
   - 向量数据的存储、查询和删除
   - 向量数据库的导入/导出
   - 向量去重和版本管理

3. **智能注入**
   - 基于语义相似度的内容检索
   - 灵活的注入位置配置
   - 支持标签提取和标签触发的内容注入

4. **任务管理**
   - 异步任务队列
   - 并发控制
   - 任务进度跟踪和状态显示

## 技术栈
- **前端框架**: jQuery + 原生JavaScript
- **UI**: HTML + CSS (无UI框架)
- **向量化引擎**: 
  - Transformers.js (本地BERT模型)
  - Ollama API
  - vLLM API
  - WebLLM (浏览器内LLM)
- **存储**: 浏览器本地存储 (IndexedDB/LocalStorage)
- **构建工具**: 无 (原生JavaScript)

## 重构目标
1. **架构优化**
   - 从单体架构迁移到分层+插件式架构
   - 实现高内聚、低耦合的模块化设计
   - 建立清晰的职责边界

2. **代码质量提升**
   - 消除代码冗余
   - 提高可维护性和可扩展性
   - 降低圈复杂度

3. **功能增强**
   - 添加LLM内容总结功能
   - 支持外部任务挂载
   - 改进用户界面和交互体验

4. **性能优化**
   - 实现更高效的任务调度
   - 优化大文本处理
   - 添加智能缓存机制

## 重构策略
采用渐进式重构方法，确保每一步都可独立验证，保持功能完整性和向后兼容性。整个重构过程分为10个阶段，从基础架构搭建到最终的清理优化，预计需要2-3周时间完成。

## 项目价值
- 为SillyTavern用户提供强大的语义搜索和内容管理能力
- 通过向量化技术增强AI对话的上下文相关性
- 支持多种向量化引擎，适应不同用户的需求和环境

## 架构设计与代码质量

### 分层架构
```
┌─────────────────────────────────────────────────────────┐
│                      应用层 (Application)                 │
│  TaskManager, TaskQueue, 业务逻辑协调                     │
├─────────────────────────────────────────────────────────┤
│                        核心层 (Core)                      │
│  实体定义, 任务系统, 管道系统, 内容提取器                   │
├─────────────────────────────────────────────────────────┤
│                         UI层 (UI)                        │
│  组件系统, 状态管理, 事件处理, 样式模块                    │
├─────────────────────────────────────────────────────────┤
│                   基础设施层 (Infrastructure)             │
│  配置管理, 存储适配, API适配, 事件总线                     │
└─────────────────────────────────────────────────────────┘
```

### 核心设计模式
- **工厂模式**：TaskFactory、ProcessorFactory统一创建接口
- **适配器模式**：StorageAdapter、VectorizationAdapter隔离外部依赖
- **策略模式**：不同任务类型和文本处理器的算法族封装
- **观察者模式**：EventBus实现松耦合的组件通信
- **依赖注入**：避免循环依赖，提高可测试性

### 代码质量指标
- **总代码行数**：约15,000行（从5000行单文件重构）
- **模块数量**：60+ 独立模块
- **圈复杂度**：大部分函数 < 10
- **依赖注入使用率**：90%+
- **循环依赖**：0（完全避免）

### 重构成果
- **可维护性**：⭐⭐⭐⭐⭐ 模块化设计，职责分离清晰
- **可扩展性**：⭐⭐⭐⭐⭐ 工厂模式支持动态扩展
- **性能**：⭐⭐⭐⭐☆ 事件防抖、批量处理、内存缓存
- **测试性**：⭐⭐⭐⭐☆ 依赖注入便于模拟测试

## 现代化进度与技术债务

### 已完成的模块化迁移
- ✅ **ConfigManager**：统一设置管理接口
- ✅ **TaskManager**：新任务系统完全接管
- ✅ **UI组件系统**：ActionButtons、ProgressManager、SettingsPanel等
- ✅ **管道架构**：已成为默认实现，删除旧实现
- ✅ **工具函数**：textChunking、contentFilter、tagExtractor等

### 当前使用率
- **实际使用率**：约85%（从60%提升）
- **代码整洁度**：大幅提升
- **新旧实现并存**：基本消除

### 剩余工作
1. **进度管理完全迁移**：将updateProgressNew调用改为ProgressManager
2. **激活插件系统**：集成已实现的插件架构
3. **充分利用EventManager/StateManager**：逐步迁移jQuery事件处理

## 未来发展规划

### 短期目标（1-2个月）
- 完成剩余模块迁移
- 建立完整的单元测试套件（目标覆盖率80%）
- 引入TypeScript提升类型安全

### 中期目标（3-6个月）
- 新的向量化源：OpenAI Embeddings v3、本地ONNX模型
- 智能摘要生成和语义聚类功能
- 构建系统优化（Webpack/Vite）

### 长期目标（6-12个月）
- 插件市场和开发者工具
- 多模态支持（图片、音频向量化）
- 企业级功能（多租户、审计日志）

### 技术栈演进
```
当前: jQuery + Vanilla JS + CSS Modules
Phase 1: jQuery + TypeScript + Jest + Webpack
Phase 2: Vue 3 + TypeScript + Vitest + Vite
Phase 3: Vue 3 + Pinia + Tailwind + Storybook
```
