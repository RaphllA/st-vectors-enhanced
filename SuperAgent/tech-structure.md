# 项目技术结构

## 主要参数
- **项目类型**: Frontend (浏览器扩展插件)
- **语言**: JavaScript
- **框架**: SillyTavern Extension Framework

## 开发环境
- **操作系统**: Windows 11
- **运行时**: 浏览器环境 (Chrome/Firefox)
- **终端**: Windows CMD
- **包管理器**: npm (通过 package.json 管理依赖)

## Git 规范
- **提交信息格式**: Conventional Commits (feat:, fix:, docs:, refactor:, test:, chore:)
- **自动 Push**: 否 (手动控制提交时机)
- **分支策略**: Feature branches (feature/xxx)

## 架构
- **类型**: 单体插件架构 (当前) → 分层+插件式架构 (目标)
- **MCP 服务器**: 不适用 (浏览器扩展环境)

## 代理设置
- **工作模式**: 交互模式 (描述计划，请求确认，讨论细节后实施)
- **注释语言**: 中文
- **虚拟环境**: 不适用 (JavaScript项目)

## 项目特性
- **向量化引擎**: Transformers.js, Ollama, vLLM, WebLLM
- **数据存储**: 浏览器本地存储
- **UI框架**: jQuery + 原生HTML/CSS
- **扩展类型**: SillyTavern 第三方扩展

## 开发规范与质量标准

### 代码规范
- **命名规范**: 驼峰命名法，类名首字母大写
- **注释语言**: 中文
- **文件组织**: 按功能模块分层组织
- **错误处理**: 统一的错误处理机制

### 质量标准
- **单元测试覆盖率**: 目标80%
- **圈复杂度**: 每个函数 < 10
- **代码重复率**: < 5%
- **依赖管理**: 使用依赖注入避免循环依赖

### 性能基准
- **初始化时间**: < 500ms
- **1000条消息向量化**: < 30s
- **查询响应时间**: < 200ms
- **内存使用**: 动态监控和优化

## 模块化架构详细说明

### 核心目录结构
```
src/
├── application/           # 应用层
│   ├── TaskManager.js    # 任务管理器
│   └── TaskQueue.js      # 任务队列
├── core/                 # 核心层
│   ├── entities/         # 实体定义
│   ├── tasks/           # 任务系统
│   ├── extractors/      # 内容提取器
│   └── plugins/         # 插件系统
├── ui/                   # UI层
│   ├── components/      # UI组件
│   ├── StateManager.js  # 状态管理
│   └── EventManager.js  # 事件管理
├── infrastructure/       # 基础设施层
│   ├── storage/         # 存储适配
│   ├── api/            # API适配
│   └── events/         # 事件总线
└── utils/               # 工具函数
```

### 模块间通信机制
- **事件总线**: 异步模块间通信
- **依赖注入**: 避免硬编码依赖
- **接口定义**: 统一的模块接口规范
- **状态管理**: 集中式状态管理

### 扩展机制
- **插件系统**: 支持第三方插件
- **工厂模式**: 动态注册新类型
- **适配器模式**: 隔离外部依赖变化
- **策略模式**: 算法族的灵活切换

## 测试策略

### 测试分层
- **单元测试**: 模块独立测试
- **集成测试**: 模块间协作测试
- **端到端测试**: 完整功能流程测试
- **性能测试**: 响应时间和资源使用测试

### 测试工具
- **框架**: Jest（单元测试）
- **模拟**: 依赖注入便于mock
- **覆盖率**: Istanbul代码覆盖率检测
- **自动化**: CI/CD集成自动测试

## 部署与维护

### 构建流程
- **开发环境**: 直接加载未压缩文件
- **生产环境**: Webpack打包压缩
- **代码分割**: 按需加载减少初始包大小
- **缓存策略**: 文件哈希缓存

### 监控与维护
- **错误监控**: 异常捕获和上报
- **性能监控**: 关键指标实时监控
- **日志管理**: 分级日志记录
- **版本管理**: 语义化版本控制

### 向后兼容策略
- **版本字段**: 数据格式版本标识
- **适配器模式**: 新旧格式转换
- **渐进式迁移**: 平滑升级路径
- **回滚机制**: 支持快速回滚
